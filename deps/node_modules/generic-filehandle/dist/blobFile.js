"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

// Using this you can "await" the file like a normal promise
// https://blog.shovonhasan.com/using-promises-with-filereader/
function readBlobAsArrayBuffer(blob) {
  var fileReader = new FileReader();
  return new Promise(function (resolve, reject) {
    fileReader.onerror = function () {
      fileReader.abort();
      reject(new Error('problem reading blob'));
    };

    fileReader.onabort = function () {
      reject(new Error('blob reading was aborted'));
    };

    fileReader.onload = function () {
      if (fileReader.result && typeof fileReader.result !== 'string') resolve(fileReader.result);else reject(new Error('unknown error reading blob'));
    };

    fileReader.readAsArrayBuffer(blob);
  });
}

function readBlobAsText(blob) {
  var fileReader = new FileReader();
  return new Promise(function (resolve, reject) {
    fileReader.onerror = function () {
      fileReader.abort();
      reject(new Error('problem reading blob'));
    };

    fileReader.onabort = function () {
      reject(new Error('blob reading was aborted'));
    };

    fileReader.onload = function () {
      if (fileReader.result && typeof fileReader.result === 'string') resolve(fileReader.result);else reject(new Error('unknown error reading blob'));
    };

    fileReader.readAsText(blob);
  });
}
/**
 * Blob of binary data fetched from a local file (with FileReader).
 *
 * Adapted by Robert Buels and Garrett Stevens from the BlobFetchable object in
 * the Dalliance Genome Explorer, which is copyright Thomas Down 2006-2011.
 */


var BlobFile = /*#__PURE__*/function () {
  function BlobFile(blob) {
    (0, _classCallCheck2.default)(this, BlobFile);
    (0, _defineProperty2.default)(this, "blob", void 0);
    (0, _defineProperty2.default)(this, "size", void 0);
    this.blob = blob;
    this.size = blob.size;
  }

  (0, _createClass2.default)(BlobFile, [{
    key: "read",
    value: function () {
      var _read = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee(buffer) {
        var offset,
            length,
            position,
            start,
            end,
            result,
            resultBuffer,
            bytesCopied,
            _args = arguments;
        return _regenerator.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                offset = _args.length > 1 && _args[1] !== undefined ? _args[1] : 0;
                length = _args.length > 2 ? _args[2] : undefined;
                position = _args.length > 3 && _args[3] !== undefined ? _args[3] : 0;

                if (length) {
                  _context.next = 5;
                  break;
                }

                return _context.abrupt("return", {
                  bytesRead: 0,
                  buffer: buffer
                });

              case 5:
                start = position;
                end = start + length;
                _context.next = 9;
                return readBlobAsArrayBuffer(this.blob.slice(start, end));

              case 9:
                result = _context.sent;
                resultBuffer = Buffer.from(result);
                bytesCopied = resultBuffer.copy(buffer, offset);
                return _context.abrupt("return", {
                  bytesRead: bytesCopied,
                  buffer: resultBuffer
                });

              case 13:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function read(_x) {
        return _read.apply(this, arguments);
      }

      return read;
    }()
  }, {
    key: "readFile",
    value: function () {
      var _readFile = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee2(options) {
        var encoding, result;
        return _regenerator.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                if (typeof options === 'string') encoding = options;else encoding = options && options.encoding;

                if (!(encoding === 'utf8')) {
                  _context2.next = 3;
                  break;
                }

                return _context2.abrupt("return", readBlobAsText(this.blob));

              case 3:
                if (!encoding) {
                  _context2.next = 5;
                  break;
                }

                throw new Error("unsupported encoding: ".concat(encoding));

              case 5:
                _context2.next = 7;
                return readBlobAsArrayBuffer(this.blob);

              case 7:
                result = _context2.sent;
                return _context2.abrupt("return", Buffer.from(result));

              case 9:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function readFile(_x2) {
        return _readFile.apply(this, arguments);
      }

      return readFile;
    }()
  }, {
    key: "stat",
    value: function () {
      var _stat = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee3() {
        return _regenerator.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                return _context3.abrupt("return", {
                  size: this.size
                });

              case 1:
              case "end":
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));

      function stat() {
        return _stat.apply(this, arguments);
      }

      return stat;
    }()
  }]);
  return BlobFile;
}();

exports.default = BlobFile;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ibG9iRmlsZS50cyJdLCJuYW1lcyI6WyJyZWFkQmxvYkFzQXJyYXlCdWZmZXIiLCJibG9iIiwiZmlsZVJlYWRlciIsIkZpbGVSZWFkZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIm9uZXJyb3IiLCJhYm9ydCIsIkVycm9yIiwib25hYm9ydCIsIm9ubG9hZCIsInJlc3VsdCIsInJlYWRBc0FycmF5QnVmZmVyIiwicmVhZEJsb2JBc1RleHQiLCJyZWFkQXNUZXh0IiwiQmxvYkZpbGUiLCJzaXplIiwiYnVmZmVyIiwib2Zmc2V0IiwibGVuZ3RoIiwicG9zaXRpb24iLCJieXRlc1JlYWQiLCJzdGFydCIsImVuZCIsInNsaWNlIiwicmVzdWx0QnVmZmVyIiwiQnVmZmVyIiwiZnJvbSIsImJ5dGVzQ29waWVkIiwiY29weSIsIm9wdGlvbnMiLCJlbmNvZGluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBO0FBQ0E7QUFDQSxTQUFTQSxxQkFBVCxDQUErQkMsSUFBL0IsRUFBaUU7QUFDL0QsTUFBTUMsVUFBVSxHQUFHLElBQUlDLFVBQUosRUFBbkI7QUFFQSxTQUFPLElBQUlDLE9BQUosQ0FBWSxVQUFDQyxPQUFELEVBQVVDLE1BQVYsRUFBMkI7QUFDNUNKLElBQUFBLFVBQVUsQ0FBQ0ssT0FBWCxHQUFxQixZQUFZO0FBQy9CTCxNQUFBQSxVQUFVLENBQUNNLEtBQVg7QUFDQUYsTUFBQUEsTUFBTSxDQUFDLElBQUlHLEtBQUosQ0FBVSxzQkFBVixDQUFELENBQU47QUFDRCxLQUhEOztBQUtBUCxJQUFBQSxVQUFVLENBQUNRLE9BQVgsR0FBcUIsWUFBWTtBQUMvQkosTUFBQUEsTUFBTSxDQUFDLElBQUlHLEtBQUosQ0FBVSwwQkFBVixDQUFELENBQU47QUFDRCxLQUZEOztBQUlBUCxJQUFBQSxVQUFVLENBQUNTLE1BQVgsR0FBb0IsWUFBWTtBQUM5QixVQUFJVCxVQUFVLENBQUNVLE1BQVgsSUFBcUIsT0FBT1YsVUFBVSxDQUFDVSxNQUFsQixLQUE2QixRQUF0RCxFQUFnRVAsT0FBTyxDQUFDSCxVQUFVLENBQUNVLE1BQVosQ0FBUCxDQUFoRSxLQUNLTixNQUFNLENBQUMsSUFBSUcsS0FBSixDQUFVLDRCQUFWLENBQUQsQ0FBTjtBQUNOLEtBSEQ7O0FBSUFQLElBQUFBLFVBQVUsQ0FBQ1csaUJBQVgsQ0FBNkJaLElBQTdCO0FBQ0QsR0FmTSxDQUFQO0FBZ0JEOztBQUVELFNBQVNhLGNBQVQsQ0FBd0JiLElBQXhCLEVBQXFEO0FBQ25ELE1BQU1DLFVBQVUsR0FBRyxJQUFJQyxVQUFKLEVBQW5CO0FBRUEsU0FBTyxJQUFJQyxPQUFKLENBQVksVUFBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQTJCO0FBQzVDSixJQUFBQSxVQUFVLENBQUNLLE9BQVgsR0FBcUIsWUFBWTtBQUMvQkwsTUFBQUEsVUFBVSxDQUFDTSxLQUFYO0FBQ0FGLE1BQUFBLE1BQU0sQ0FBQyxJQUFJRyxLQUFKLENBQVUsc0JBQVYsQ0FBRCxDQUFOO0FBQ0QsS0FIRDs7QUFLQVAsSUFBQUEsVUFBVSxDQUFDUSxPQUFYLEdBQXFCLFlBQVk7QUFDL0JKLE1BQUFBLE1BQU0sQ0FBQyxJQUFJRyxLQUFKLENBQVUsMEJBQVYsQ0FBRCxDQUFOO0FBQ0QsS0FGRDs7QUFJQVAsSUFBQUEsVUFBVSxDQUFDUyxNQUFYLEdBQW9CLFlBQVk7QUFDOUIsVUFBSVQsVUFBVSxDQUFDVSxNQUFYLElBQXFCLE9BQU9WLFVBQVUsQ0FBQ1UsTUFBbEIsS0FBNkIsUUFBdEQsRUFBZ0VQLE9BQU8sQ0FBQ0gsVUFBVSxDQUFDVSxNQUFaLENBQVAsQ0FBaEUsS0FDS04sTUFBTSxDQUFDLElBQUlHLEtBQUosQ0FBVSw0QkFBVixDQUFELENBQU47QUFDTixLQUhEOztBQUlBUCxJQUFBQSxVQUFVLENBQUNhLFVBQVgsQ0FBc0JkLElBQXRCO0FBQ0QsR0FmTSxDQUFQO0FBZ0JEO0FBRUQ7Ozs7Ozs7O0lBTXFCZSxRO0FBR25CLG9CQUFtQmYsSUFBbkIsRUFBK0I7QUFBQTtBQUFBO0FBQUE7QUFDN0IsU0FBS0EsSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS2dCLElBQUwsR0FBWWhCLElBQUksQ0FBQ2dCLElBQWpCO0FBQ0Q7Ozs7OzJHQUdDQyxNOzs7Ozs7Ozs7Ozs7OztBQUNBQyxnQkFBQUEsTSwyREFBUyxDO0FBQ1RDLGdCQUFBQSxNO0FBQ0FDLGdCQUFBQSxRLDJEQUFXLEM7O29CQUlORCxNOzs7OztpREFDSTtBQUFFRSxrQkFBQUEsU0FBUyxFQUFFLENBQWI7QUFBZ0JKLGtCQUFBQSxNQUFNLEVBQU5BO0FBQWhCLGlCOzs7QUFHSEssZ0JBQUFBLEssR0FBUUYsUTtBQUNSRyxnQkFBQUEsRyxHQUFNRCxLQUFLLEdBQUdILE07O3VCQUVDcEIscUJBQXFCLENBQUMsS0FBS0MsSUFBTCxDQUFVd0IsS0FBVixDQUFnQkYsS0FBaEIsRUFBdUJDLEdBQXZCLENBQUQsQzs7O0FBQXBDWixnQkFBQUEsTTtBQUNBYyxnQkFBQUEsWSxHQUFlQyxNQUFNLENBQUNDLElBQVAsQ0FBWWhCLE1BQVosQztBQUVmaUIsZ0JBQUFBLFcsR0FBY0gsWUFBWSxDQUFDSSxJQUFiLENBQWtCWixNQUFsQixFQUEwQkMsTUFBMUIsQztpREFFYjtBQUFFRyxrQkFBQUEsU0FBUyxFQUFFTyxXQUFiO0FBQTBCWCxrQkFBQUEsTUFBTSxFQUFFUTtBQUFsQyxpQjs7Ozs7Ozs7Ozs7Ozs7Ozs7OztnSEFHYUssTzs7Ozs7O0FBRXBCLG9CQUFJLE9BQU9BLE9BQVAsS0FBbUIsUUFBdkIsRUFBaUNDLFFBQVEsR0FBR0QsT0FBWCxDQUFqQyxLQUNLQyxRQUFRLEdBQUdELE9BQU8sSUFBSUEsT0FBTyxDQUFDQyxRQUE5Qjs7c0JBQ0RBLFFBQVEsS0FBSyxNOzs7OztrREFBZWxCLGNBQWMsQ0FBQyxLQUFLYixJQUFOLEM7OztxQkFDMUMrQixROzs7OztzQkFBZ0IsSUFBSXZCLEtBQUosaUNBQW1DdUIsUUFBbkMsRTs7Ozt1QkFDQ2hDLHFCQUFxQixDQUFDLEtBQUtDLElBQU4sQzs7O0FBQXBDVyxnQkFBQUEsTTtrREFDQ2UsTUFBTSxDQUFDQyxJQUFQLENBQVloQixNQUFaLEM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztrREFJQTtBQUFFSyxrQkFBQUEsSUFBSSxFQUFFLEtBQUtBO0FBQWIsaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBHZW5lcmljRmlsZWhhbmRsZSwgRmlsZWhhbmRsZU9wdGlvbnMsIFN0YXRzIH0gZnJvbSAnLi9maWxlaGFuZGxlJ1xuXG4vLyBVc2luZyB0aGlzIHlvdSBjYW4gXCJhd2FpdFwiIHRoZSBmaWxlIGxpa2UgYSBub3JtYWwgcHJvbWlzZVxuLy8gaHR0cHM6Ly9ibG9nLnNob3Zvbmhhc2FuLmNvbS91c2luZy1wcm9taXNlcy13aXRoLWZpbGVyZWFkZXIvXG5mdW5jdGlvbiByZWFkQmxvYkFzQXJyYXlCdWZmZXIoYmxvYjogQmxvYik6IFByb21pc2U8QXJyYXlCdWZmZXI+IHtcbiAgY29uc3QgZmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKClcblxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCk6IHZvaWQgPT4ge1xuICAgIGZpbGVSZWFkZXIub25lcnJvciA9ICgpOiB2b2lkID0+IHtcbiAgICAgIGZpbGVSZWFkZXIuYWJvcnQoKVxuICAgICAgcmVqZWN0KG5ldyBFcnJvcigncHJvYmxlbSByZWFkaW5nIGJsb2InKSlcbiAgICB9XG5cbiAgICBmaWxlUmVhZGVyLm9uYWJvcnQgPSAoKTogdm9pZCA9PiB7XG4gICAgICByZWplY3QobmV3IEVycm9yKCdibG9iIHJlYWRpbmcgd2FzIGFib3J0ZWQnKSlcbiAgICB9XG5cbiAgICBmaWxlUmVhZGVyLm9ubG9hZCA9ICgpOiB2b2lkID0+IHtcbiAgICAgIGlmIChmaWxlUmVhZGVyLnJlc3VsdCAmJiB0eXBlb2YgZmlsZVJlYWRlci5yZXN1bHQgIT09ICdzdHJpbmcnKSByZXNvbHZlKGZpbGVSZWFkZXIucmVzdWx0KVxuICAgICAgZWxzZSByZWplY3QobmV3IEVycm9yKCd1bmtub3duIGVycm9yIHJlYWRpbmcgYmxvYicpKVxuICAgIH1cbiAgICBmaWxlUmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKGJsb2IpXG4gIH0pXG59XG5cbmZ1bmN0aW9uIHJlYWRCbG9iQXNUZXh0KGJsb2I6IEJsb2IpOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCBmaWxlUmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKVxuXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KTogdm9pZCA9PiB7XG4gICAgZmlsZVJlYWRlci5vbmVycm9yID0gKCk6IHZvaWQgPT4ge1xuICAgICAgZmlsZVJlYWRlci5hYm9ydCgpXG4gICAgICByZWplY3QobmV3IEVycm9yKCdwcm9ibGVtIHJlYWRpbmcgYmxvYicpKVxuICAgIH1cblxuICAgIGZpbGVSZWFkZXIub25hYm9ydCA9ICgpOiB2b2lkID0+IHtcbiAgICAgIHJlamVjdChuZXcgRXJyb3IoJ2Jsb2IgcmVhZGluZyB3YXMgYWJvcnRlZCcpKVxuICAgIH1cblxuICAgIGZpbGVSZWFkZXIub25sb2FkID0gKCk6IHZvaWQgPT4ge1xuICAgICAgaWYgKGZpbGVSZWFkZXIucmVzdWx0ICYmIHR5cGVvZiBmaWxlUmVhZGVyLnJlc3VsdCA9PT0gJ3N0cmluZycpIHJlc29sdmUoZmlsZVJlYWRlci5yZXN1bHQpXG4gICAgICBlbHNlIHJlamVjdChuZXcgRXJyb3IoJ3Vua25vd24gZXJyb3IgcmVhZGluZyBibG9iJykpXG4gICAgfVxuICAgIGZpbGVSZWFkZXIucmVhZEFzVGV4dChibG9iKVxuICB9KVxufVxuXG4vKipcbiAqIEJsb2Igb2YgYmluYXJ5IGRhdGEgZmV0Y2hlZCBmcm9tIGEgbG9jYWwgZmlsZSAod2l0aCBGaWxlUmVhZGVyKS5cbiAqXG4gKiBBZGFwdGVkIGJ5IFJvYmVydCBCdWVscyBhbmQgR2FycmV0dCBTdGV2ZW5zIGZyb20gdGhlIEJsb2JGZXRjaGFibGUgb2JqZWN0IGluXG4gKiB0aGUgRGFsbGlhbmNlIEdlbm9tZSBFeHBsb3Jlciwgd2hpY2ggaXMgY29weXJpZ2h0IFRob21hcyBEb3duIDIwMDYtMjAxMS5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQmxvYkZpbGUgaW1wbGVtZW50cyBHZW5lcmljRmlsZWhhbmRsZSB7XG4gIHByaXZhdGUgYmxvYjogQmxvYlxuICBwcml2YXRlIHNpemU6IG51bWJlclxuICBwdWJsaWMgY29uc3RydWN0b3IoYmxvYjogQmxvYikge1xuICAgIHRoaXMuYmxvYiA9IGJsb2JcbiAgICB0aGlzLnNpemUgPSBibG9iLnNpemVcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFkKFxuICAgIGJ1ZmZlcjogQnVmZmVyLFxuICAgIG9mZnNldCA9IDAsXG4gICAgbGVuZ3RoOiBudW1iZXIsXG4gICAgcG9zaXRpb24gPSAwLFxuICApOiBQcm9taXNlPHsgYnl0ZXNSZWFkOiBudW1iZXI7IGJ1ZmZlcjogQnVmZmVyIH0+IHtcbiAgICAvLyBzaG9ydC1jaXJjdWl0IGEgcmVhZCBvZiAwIGJ5dGVzIGhlcmUsIGJlY2F1c2UgYnJvd3NlcnMgYWN0dWFsbHkgc29tZXRpbWVzXG4gICAgLy8gY3Jhc2ggaWYgeW91IHRyeSB0byByZWFkIDAgYnl0ZXMgZnJvbSBhIGxvY2FsIGZpbGUhXG4gICAgaWYgKCFsZW5ndGgpIHtcbiAgICAgIHJldHVybiB7IGJ5dGVzUmVhZDogMCwgYnVmZmVyIH1cbiAgICB9XG5cbiAgICBjb25zdCBzdGFydCA9IHBvc2l0aW9uXG4gICAgY29uc3QgZW5kID0gc3RhcnQgKyBsZW5ndGhcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlYWRCbG9iQXNBcnJheUJ1ZmZlcih0aGlzLmJsb2Iuc2xpY2Uoc3RhcnQsIGVuZCkpXG4gICAgY29uc3QgcmVzdWx0QnVmZmVyID0gQnVmZmVyLmZyb20ocmVzdWx0KVxuXG4gICAgY29uc3QgYnl0ZXNDb3BpZWQgPSByZXN1bHRCdWZmZXIuY29weShidWZmZXIsIG9mZnNldClcblxuICAgIHJldHVybiB7IGJ5dGVzUmVhZDogYnl0ZXNDb3BpZWQsIGJ1ZmZlcjogcmVzdWx0QnVmZmVyIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWFkRmlsZShvcHRpb25zPzogRmlsZWhhbmRsZU9wdGlvbnMgfCBzdHJpbmcpOiBQcm9taXNlPEJ1ZmZlciB8IHN0cmluZz4ge1xuICAgIGxldCBlbmNvZGluZ1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIGVuY29kaW5nID0gb3B0aW9uc1xuICAgIGVsc2UgZW5jb2RpbmcgPSBvcHRpb25zICYmIG9wdGlvbnMuZW5jb2RpbmdcbiAgICBpZiAoZW5jb2RpbmcgPT09ICd1dGY4JykgcmV0dXJuIHJlYWRCbG9iQXNUZXh0KHRoaXMuYmxvYilcbiAgICBpZiAoZW5jb2RpbmcpIHRocm93IG5ldyBFcnJvcihgdW5zdXBwb3J0ZWQgZW5jb2Rpbmc6ICR7ZW5jb2Rpbmd9YClcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZWFkQmxvYkFzQXJyYXlCdWZmZXIodGhpcy5ibG9iKVxuICAgIHJldHVybiBCdWZmZXIuZnJvbShyZXN1bHQpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3RhdCgpOiBQcm9taXNlPFN0YXRzPiB7XG4gICAgcmV0dXJuIHsgc2l6ZTogdGhpcy5zaXplIH1cbiAgfVxufVxuIl19